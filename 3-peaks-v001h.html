<!DOCTYPE html>
<html lang="pt-br">
<head>
  <meta charset="UTF-8" />
  <title>Tri Peaks Solitaire — v1.13</title>
  <style>
    :root {
      --card-w: 70px;
      --card-h: 100px;
      --gap-x: 22px;
      --gap-y: 5px;
      --board-margin: 0px;
    }
    * { box-sizing: border-box; margin: 0; padding: 0; }
    body { background: #2e7d32; color: #fff; font-family: sans-serif; }

    #header {
      width: 100%;
      background: #1b5e20;
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 10px 14px;
      flex-wrap: wrap;
    }
    .stat { margin: 0 10px; }
    button { padding: 6px 12px; font-weight: bold; margin-left: 8px; cursor: pointer; }

    #game {
      display: flex;
      flex-direction: column;
      align-items: center;
      margin-top: 20px;
    }

    #tableau, #stockArea {
      transition: opacity 0.3s ease;
    }

    #tableau {
      position: relative;
      width: calc((10 * var(--card-w)) + 10 * var(--gap-x) + 2 * var(--board-margin));
      height: calc(4 * var(--card-h) + 3 * var(--gap-y));
      margin: 0 auto;
    }

    #stockArea {
      display: flex;
      gap: 10px;
      margin-top: 5px;
    }
    #stockArea .card { position: relative; }

    .card {
      width: var(--card-w);
      height: var(--card-h);
      border: 3px solid #000;
      border-radius: 8px;
      box-shadow: 1px 2px 5px rgba(0, 0, 0, 0.45);
      background: #fff;
      position: absolute;
      display: flex;
      align-items: center;
      justify-content: center;
      font-weight: bold;
      user-select: none;
    }

    .card.face-down {
      background: repeating-linear-gradient(45deg, #d32f2f 0 5px, #b71c1c 5px 10px);
      color: transparent;
      box-shadow: none;
      cursor: default;
    }

    .card.red { color: red; }
    .card.black { color: black; }
    .card.wild { background: gold; color: #000; }

    .corner { position: absolute; font-size: 12px; }
    .corner.top { top: 4px; left: 6px; }
    .corner.bot { bottom: 4px; right: 6px; }
    .center { font-size: 28px; }

    #discardList {
      margin-top: 20px;
      background: #1b5e20;
      padding: 10px;
      border-radius: 6px;
      max-width: 300px;
      width: 90%;
      display: none;
    }
    #discardList h2 {
      text-align: center;
      margin-bottom: 10px;
      font-size: 18px;
    }
    #discardList ul {
      list-style: none;
      padding-left: 0;
      text-align: center;
    }
  </style>
</head>
<body>

  <div id="header">
    <div class="stat">Pontos: <span id="score">0</span></div>
    <div class="stat">Tempo: <span id="time">00:00</span></div>
    <div class="stat">Combo: <span id="combo">0</span></div>
    <div class="stat">Curingas: <span id="wildsUsed">0</span></div>
    <div class="stat">Estoque: <span id="stockCount">0</span></div>
    <div class="stat">Descarte: <span id="wasteCount">0</span></div>
    <div>
      <button id="undoButton" onclick="undoMove()">Desfazer (1)</button>
      <button onclick="confirmNewGame()">Nova Partida</button>
      <button onclick="showInstructions()">?</button>
    </div>
  </div>

  <div id="game">
    <div id="tableau"></div>
    <div id="stockArea">
      <div id="stock" class="card face-down" onclick="drawFromStock()"></div>
      <div id="waste" class="card"></div>
    </div>
    <div id="discardList">
      <h2>Cartas no Descarte</h2>
      <ul id="discardItems"></ul>
    </div>
  </div>

  <script>
    const suits = ['♠','♥','♦','♣'],
          values = ['A','2','3','4','5','6','7','8','9','10','J','Q','K'];
    const pos = ['A1','A2','A3','A4','A5','A6','A7','A8','A9','A10','B1','B2','B3','B4','B5','B6','B7','B8','B9','C1','C2','C3','C4','C5','C6','D1','D2','D3'];
    const child = {
      D1:['C1','C2'],D2:['C3','C4'],D3:['C5','C6'],C1:['B1','B2'],C2:['B2','B3'],C3:['B4','B5'],
      C4:['B5','B6'],C5:['B7','B8'],C6:['B8','B9'],B1:['A1','A2'],B2:['A2','A3'],B3:['A3','A4'],
      B4:['A4','A5'],B5:['A5','A6'],B6:['A6','A7'],B7:['A7','A8'],B8:['A8','A9'],B9:['A9','A10']
    };
    const loc = {
      A1:[0,3],A2:[1,3],A3:[2,3],A4:[3,3],A5:[4,3],A6:[5,3],A7:[6,3],A8:[7,3],A9:[8,3],A10:[9,3],
      B1:[0.5,2],B2:[1.5,2],B3:[2.5,2],B4:[3.5,2],B5:[4.5,2],B6:[5.5,2],B7:[6.5,2],B8:[7.5,2],B9:[8.5,2],
      C1:[1,1],C2:[2,1],C3:[4,1],C4:[5,1],C5:[7,1],C6:[8,1],D1:[1.5,0],D2:[4.5,0],D3:[7.5,0]
    };

    let deck = [], stock = [], waste = {}, cards = {}, undoStack = [];
    let undoLimit = 1;
    let wasteCount = 0;
    let discardSequence = [];

    const shuffle = a => { for(let i=a.length-1;i>0;i--){ const j=Math.floor(Math.random()*(i+1)); [a[i],a[j]]=[a[j],a[i]]; } };
    const val = v => v==='A'?1:v==='J'?11:v==='Q'?12:v==='K'?13:v==='★'?0:+v;
    const html = (v,s) => `<div class='corner top'>${v}${s}</div><div class='center'>${s}</div><div class='corner bot'>${v}${s}</div>`;

    function suitClass(e,s){ e.classList.remove('red','black','wild'); if(s==='*')e.classList.add('wild'); else e.classList.add(['♥','♦'].includes(s)?'red':'black'); }
    function place(e,[c,r]){ const cw=70,ch=100,gx=10,gy=-2,m=0; e.style.left=`${m+c*(cw+gx)}px`; e.style.top=`${r*(ch+gy)}px`; }

    function createCard(d,p,up){
      const e = document.createElement('div');
      e.className = 'card table-card';
      if (up){ suitClass(e,d.suit); e.innerHTML = html(d.value,d.suit); e.onclick = () => playCard(p); }
      else { e.classList.add('face-down'); }
      place(e, loc[p]); e.dataset.value = d.value; e.dataset.suit = d.suit; e.dataset.pos = p; cards[p] = e;
      return e;
    }

    function buildDeck(){
      deck=[]; for(const s of suits)for(const v of values)deck.push({suit:s,value:v});
      deck.push({suit:'*',value:'★'},{suit:'*',value:'★'}); shuffle(deck);
    }

    function startNewGame(){
      document.getElementById('tableau').style.display = '';
      document.getElementById('stockArea').style.display = '';
      document.getElementById('discardList').style.display = 'none';
      document.getElementById('undoButton').disabled = false;
      discardSequence = [];

      const t = document.getElementById('tableau'); t.innerHTML=''; cards={}; undoStack=[];
      buildDeck(); const pyr = deck.splice(0,28);
      pos.forEach((p,i)=>t.appendChild(createCard(pyr[i],p,p.startsWith('A'))));
      stock = [...deck]; wasteCount = 0;
      flipStock(); // conta 1
      undoLimit = 1; updateUndoButton(); updateStockCount(); updateWasteCount(); update();
    }

    function updateUndoButton(){ document.getElementById('undoButton').innerText = `Desfazer (${undoLimit})`; }
    function updateStockCount(){ document.getElementById('stockCount').innerText = stock.length; }
    function updateWasteCount(){ document.getElementById('wasteCount').innerText = wasteCount; }

    function flipStock(){
      if(!stock.length) return;
      waste = stock.shift(); updateStockCount();
      discardSequence.push(`${waste.value}${waste.suit}`);
      wasteCount++; updateWasteCount();
      const w = document.getElementById('waste');
      w.className='card'; suitClass(w,waste.suit); w.innerHTML=html(waste.value,waste.suit);
      document.getElementById('stock').style.visibility = stock.length ? 'visible' : 'hidden';
      update();
    }

    function drawFromStock(){ save(); flipStock(); }

    function playCard(p){
      const e=cards[p]; if(!e||e.classList.contains('face-down'))return;
      const cv=val(e.dataset.value),wv=val(waste.value);
      if(!(cv===0||wv===0||Math.abs(cv-wv)===1||(cv===13&&wv===1)||(cv===1&&wv===13)))return;
      save(); delete cards[p]; e.remove();
      waste = { value: e.dataset.value, suit: e.dataset.suit };
      discardSequence.push(`${waste.value}${waste.suit}`);
      wasteCount++; updateWasteCount();
      const w=document.getElementById('waste');
      w.className='card'; suitClass(w,waste.suit); w.innerHTML=html(waste.value,waste.suit);
      update();
    }

    function update(){
      for(const p of pos){
        const e=cards[p]; if(!e)continue;
        const blocked=(child[p]||[]).some(ch=>cards[ch]);
        if(blocked&&!e.classList.contains('face-down')){
          e.classList.add('face-down'); e.onclick=null; e.innerHTML='';
        } else if(!blocked&&e.classList.contains('face-down')){
          e.classList.remove('face-down');
          suitClass(e,e.dataset.suit); e.innerHTML=html(e.dataset.value,e.dataset.suit);
          e.onclick=()=>playCard(p);
        }
      }
      checkEnd();
    }

    function checkEnd(){
      if(!Object.keys(cards).length){
        alert("Vitória! Você removeu todas as cartas.");
        showDiscardSequence();
      } else if(!stock.length && !movesLeft()){
        alert("Derrota! Sem movimentos restantes.");
        startNewGame();
      }
    }

    function movesLeft(){
      const wv=val(waste.value);
      return pos.some(p=>{
        const e=cards[p]; if(!e||e.classList.contains('face-down'))return false;
        const cv=val(e.dataset.value);
        return cv===0||wv===0||Math.abs(cv-wv)===1||(cv===13&&wv===1)||(cv===1&&wv===13);
      });
    }

    function showDiscardSequence() {
      document.getElementById('tableau').style.display = 'none';
      document.getElementById('stockArea').style.display = 'none';
      document.getElementById('discardList').style.display = 'block';
      document.getElementById('undoButton').disabled = true;
      const ul = document.getElementById('discardItems');
      ul.innerHTML = '';
      discardSequence.forEach(card => {
        const li = document.createElement('li');
        li.textContent = card;
        ul.appendChild(li);
      });
    }

    function save(){
      undoStack.push({
        html: document.getElementById('tableau').innerHTML,
        stock: [...stock], waste: {...waste}, wasteCount
      });
      if(undoStack.length>10)undoStack.shift();
    }

    function undoMove(){
      if(undoLimit<1){ alert("Você já usou todas as suas ações de desfazer."); return; }
      if(!undoStack.length){ alert("Nada a desfazer."); return; }
      const s = undoStack.pop(); stock = [...s.stock]; waste = {...s.waste}; wasteCount = s.wasteCount;
      updateStockCount(); updateWasteCount();
      const t = document.getElementById('tableau'); t.innerHTML = s.html;
      cards={}; t.querySelectorAll('.card').forEach(el => {
        cards[el.dataset.pos]=el;
        if(!el.classList.contains('face-down'))
          el.onclick=()=>playCard(el.dataset.pos);
      });
      const w = document.getElementById('waste');
      w.className='card'; suitClass(w,waste.suit); w.innerHTML=html(waste.value,waste.suit);
      document.getElementById('stock').style.visibility = stock.length ? 'visible' : 'hidden';
      undoLimit--; updateUndoButton(); update();
    }

    function confirmNewGame(){
      if(confirm("Você tem certeza que quer iniciar uma nova partida?")) startNewGame();
    }

    function showInstructions(){
      alert("Como jogar:\n\n• Remova cartas clicando em valores adjacentes (+1 ou −1) à carta do descarte (loop A-K-2).\n• Curingas (★) podem substituir qualquer valor.\n• Você vence ao limpar todas as cartas da pirâmide.\n• Clique no estoque para puxar uma nova carta.");
    }

    window.onload = startNewGame;
  </script>
</body>
</html>



